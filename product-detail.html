<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Details - DMwithAI Demo Store</title>
  <link rel="stylesheet" href="styles.css">
<script>
  const COLLECTOR_BASE = "http://localhost:8002";
  const TENANT_ID = "2";
  const SITE_TOKEN = "icE56lQxxTWOwTR8dntpNkj-I-Vrxl0-";
  function sid() {
    const k = "_our_sid"; let v = sessionStorage.getItem(k);
    if (!v) { v = Math.random().toString(36).slice(2)+Date.now().toString(36); sessionStorage.setItem(k, v); }
    return v;
  }
  function getParams() {
    const sp = new URLSearchParams(location.search);
    const g = k => sp.get(k) || undefined;
    return { utm: { source:g('utm_source'), medium:g('utm_medium'), campaign:g('utm_campaign'), term:g('utm_term'), content:g('utm_content') },
              clid: { gclid:g('gclid'), fbclid:g('fbclid'), ttclid:g('ttclid') } };
  }
  function sendEvent(type, extra = {}) {
    const payload = { t:type, tenantId:TENANT_ID, siteToken:SITE_TOKEN, url:location.href, ref:document.referrer||null, sid:sid(), ...getParams(), ...extra };
    const body = JSON.stringify(payload);
    if (navigator.sendBeacon) {
      navigator.sendBeacon(`${COLLECTOR_BASE}/collect`, new Blob([body], { type: 'text/plain;charset=UTF-8' }));
      return;
    }
    fetch(`${COLLECTOR_BASE}/collect`, {
      method:'POST',
      headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
      body,
      keepalive:true
    }).catch(()=>{});
  }
  sendEvent('pageview');
  // Send product_view event when product detail page loads
  sendEvent('product_view', {
    product_id: productId,
    product_name: productName,
    product_price: productPrice
  });
  (function(){
    let engaged=false;
    const markEngaged=()=>{ if(engaged) return; engaged=true; sendEvent('engaged'); };
    const markBounce =()=>{ if(engaged) return; sendEvent('bounce'); };
    setTimeout(markEngaged, 30_000);
    window.addEventListener('scroll', ()=>{ const s=(window.scrollY+window.innerHeight)/(document.documentElement.scrollHeight||1); if(s>=0.75) markEngaged(); }, { passive:true });
    window.addEventListener('beforeunload', markBounce);
  })();

  // Get product details from URL
  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get('id') || '1';
  const productName = urlParams.get('name') || 'Product';
  const prices = { '1': 29.99, '2': 49.99, '3': 79.99, '4': 99.99, '5': 149.99, '6': 199.99 };
  const productPrice = prices[productId] || 29.99;

  function handleAddToCart() {
    // Send add_to_cart event for CVR funnel tracking
    sendEvent('add_to_cart', {
      product_id: productId,
      product_name: productName,
      product_price: productPrice
    });
    alert('Added to cart! (Add to cart event tracked)');
  }

  function handlePurchase() {
    sendEvent('conversion', {
      goal: 'purchase',
      value: productPrice,
      product_id: productId,
      product_name: productName
    });
    alert('Purchase completed! (Conversion event tracked)');
  }
</script>
<script>
  (function() {
    var SURVEY_ID = "87f5fc72-c161-4c98-90a7-4b6baa7e50b3";
    var EXP_DAYS = 7;
    var SURVEY_APP_BASE = "https://0328-41-90-186-108.ngrok-free.app";
    var AUTO_TRIGGER = true;
    var AUTO_DELAY_MS = 20000;
    var COOLDOWN_DAYS = 7;
    var sid = (function() {
      try {
        return localStorage.getItem("_our_sid") || "";
      } catch (e) {
        return "";
      }
    })();
    var userKey = (window.DMWIdentity && (window.DMWIdentity.user_key || window.DMWIdentity.user_id)) || "";

    function openSurvey(opts) {
      var usePopup = opts && opts.popup;
      fetch("https://6e3e-41-90-186-108.ngrok-free.app/api/surveys/public/" + SURVEY_ID + "/session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sid: sid, user_key: userKey, exp_days: EXP_DAYS })
      })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          if (!data.survey_token) return;
          var url = SURVEY_APP_BASE + "/surveys/public/" + SURVEY_ID + "?st=" + encodeURIComponent(data.survey_token) + "&origin=website";
          if (usePopup) {
            window.open(url, "_blank");
          } else {
            window.location.href = url;
          }
        });
    }

    // Example trigger: call openSurvey() on a button click
    window.DMWSurveyOpen = function() { return openSurvey({ popup: true }); };

    // Auto-trigger (optional, once per cooldown)
    if (AUTO_TRIGGER) {
      var shownKey = "survey_shown_" + SURVEY_ID;
      var lastShown = parseInt(localStorage.getItem(shownKey) || "0", 10);
      var cooldownMs = COOLDOWN_DAYS * 24 * 60 * 60 * 1000;
      if (Date.now() - lastShown > cooldownMs) {
        setTimeout(function() {
          openSurvey({ popup: false });
          localStorage.setItem(shownKey, Date.now().toString());
        }, AUTO_DELAY_MS);
      }
    }
  })();
</script>
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <a href="index.html" class="logo">DMwithAI Store</a>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="products.html">Products</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
    </div>
  </nav>

  <main class="container">
    <a href="products.html" class="back-link">‚Üê Back to Products</a>
    
    <div class="product-detail">
      <div class="product-detail-image">
        <div class="product-image-large">üì¶</div>
      </div>
      <div class="product-detail-info">
        <h1 id="product-title">Demo Product</h1>
        <p class="product-price-large" id="product-price">$<script>document.write(productPrice.toFixed(2))</script></p>
        <p class="description">This is a demo product for testing cohort retention and audience segmentation features. Interact with the buttons below to generate conversion events.</p>
        
        <div class="product-actions">
          <button onclick="handleAddToCart()" class="btn btn-primary btn-large">Add to Cart</button>
          <button onclick="handlePurchase()" class="btn btn-success btn-large">Buy Now</button>
        </div>

        <div class="product-features">
          <h3>Features</h3>
          <ul>
            <li>‚úÖ Generates conversion events</li>
            <li>‚úÖ Tracks product views</li>
            <li>‚úÖ Records purchase value</li>
            <li>‚úÖ Tests cohort retention</li>
            <li>‚úÖ Enables audience segmentation</li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 DMwithAI Demo Store. Built for testing analytics modules.</p>
    </div>
  </footer>

  <script>
    document.getElementById('product-title').textContent = productName;
  </script>
</body>
</html>
