<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DMwithAI Demo Store - Home</title>
  <link rel="stylesheet" href="styles.css">
<!-- Google tag (gtag.js) -->
<script>
  /* === CONFIG (generated) === */
  const COLLECTOR_BASE = "http://localhost:8002";
  const TENANT_ID = "2";
  const SITE_TOKEN = "icE56lQxxTWOwTR8dntpNkj-I-Vrxl0-";

  function sid() {
    const k = "_our_sid"; let v = sessionStorage.getItem(k);
    if (!v) { v = Math.random().toString(36).slice(2)+Date.now().toString(36); sessionStorage.setItem(k, v); }
    return v;
  }
  function getParams() {
    // Try multiple sources for UTM params (in order of preference):
    
    // 1. Try to get from Performance API (original request URL before redirects)
    let originalUrl = null;
    try {
      const navEntries = performance.getEntriesByType('navigation');
      if (navEntries.length > 0 && navEntries[0].name) {
        originalUrl = navEntries[0].name;
      }
    } catch(e) {
      // Performance API not available
    }
    
    // 2. Try current URL
    let sp = new URLSearchParams(location.search);
    let g = k => sp.get(k) || undefined;
    
    // 3. If current URL has no params, try original URL from Performance API
    if (Object.keys(Array.from(sp.keys())).length === 0 && originalUrl && originalUrl !== location.href) {
      try {
        const origUrlObj = new URL(originalUrl);
        sp = new URLSearchParams(origUrlObj.search);
        g = k => sp.get(k) || undefined;
      } catch(e) {
        // Ignore URL parsing errors
      }
    }
    
    // 4. Extract UTM params
    let utm = { source:g('utm_source'), medium:g('utm_medium'), campaign:g('utm_campaign'), term:g('utm_term'), content:g('utm_content') };
    let clid = { gclid:g('gclid'), fbclid:g('fbclid'), ttclid:g('ttclid') };
    
    // 5. If still no params, try referrer
    if (Object.keys(utm).filter(k => utm[k]).length === 0 && document.referrer) {
      try {
        const refUrl = new URL(document.referrer);
        const refSp = new URLSearchParams(refUrl.search);
        const refG = k => refSp.get(k) || undefined;
        utm = { source:refG('utm_source'), medium:refG('utm_medium'), campaign:refG('utm_campaign'), term:refG('utm_term'), content:refG('utm_content') };
        clid = { gclid:refG('gclid'), fbclid:refG('fbclid'), ttclid:refG('ttclid') };
      } catch(e) {
        // Ignore URL parsing errors
      }
    }
    
    // Remove undefined values
    const cleanUtm = {};
    const cleanClid = {};
    Object.keys(utm).forEach(k => { if (utm[k]) cleanUtm[k] = utm[k]; });
    Object.keys(clid).forEach(k => { if (clid[k]) cleanClid[k] = clid[k]; });
    
    // Save to sessionStorage for persistence across page navigations
    if (Object.keys(cleanUtm).length > 0 || Object.keys(cleanClid).length > 0) {
      try {
        sessionStorage.setItem('_utm_params', JSON.stringify({ utm: cleanUtm, clid: cleanClid }));
      } catch(e) {
        // Ignore storage errors (private mode, etc.)
      }
      return { utm: cleanUtm, clid: cleanClid };
    }
    
    // If still no params, try to restore from sessionStorage
    try {
      const stored = sessionStorage.getItem('_utm_params');
      if (stored) {
        const parsed = JSON.parse(stored);
        if (parsed.utm && Object.keys(parsed.utm).length > 0) {
          return { utm: parsed.utm, clid: parsed.clid || {} };
        }
      }
    } catch(e) {
      // Ignore storage errors
    }
    
    // No UTM params found
    return { utm: {}, clid: {} };
  }
  function sendEvent(type, extra = {}) {
    const params = getParams();
    // Merge extra UTM params (from test buttons) with URL params - extra takes precedence
    const mergedUtm = {...params.utm, ...(extra.utm || {})};
    const mergedClid = {...params.clid, ...(extra.clid || {})};
    const finalParams = { utm: mergedUtm, clid: mergedClid };
    
    // Debug: log what's being sent
    if (Object.keys(finalParams.utm).length > 0 || Object.keys(finalParams.clid).length > 0) {
      console.log('ðŸ” Sending event with UTM:', JSON.stringify(finalParams, null, 2));
    }
    
    // Build payload - extract utm/clid from extra to avoid duplication
    const {utm: extraUtm, clid: extraClid, ...extraWithoutUtm} = extra;
    const payload = { 
      t:type, 
      tenantId:TENANT_ID, 
      siteToken:SITE_TOKEN, 
      url:location.href, 
      ref:document.referrer||null, 
      sid:sid(), 
      utm: finalParams.utm,
      clid: finalParams.clid,
      ...extraWithoutUtm
    };
    const body = JSON.stringify(payload);
    if (navigator.sendBeacon) {
      navigator.sendBeacon(`${COLLECTOR_BASE}/collect`, new Blob([body], { type: 'text/plain;charset=UTF-8' }));
      return;
    }
    fetch(`${COLLECTOR_BASE}/collect`, {
      method:'POST',
      headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
      body,
      keepalive:true
    }).catch(()=>{});
  }
  // Log current URL and UTM params on page load for debugging
  (function() {
    const urlHasParams = location.search.includes('utm_') || location.search.includes('gclid') || location.search.includes('fbclid');
    let originalUrl = null;
    try {
      const navEntries = performance.getEntriesByType('navigation');
      if (navEntries.length > 0 && navEntries[0].name) {
        originalUrl = navEntries[0].name;
      }
    } catch(e) {}
    
    const params = getParams();
    console.log('ðŸ“ Page loaded - Current URL:', location.href);
    if (originalUrl && originalUrl !== location.href) {
      console.log('ðŸ“ Original URL (before redirect):', originalUrl);
    }
    console.log('ðŸ“ URL has query params:', urlHasParams);
    console.log('ðŸ“ UTM params found:', params);
    if (Object.keys(params.utm).length > 0 || Object.keys(params.clid).length > 0) {
      console.log('âœ… UTM parameters will be sent to collector');
      if (params.utm.medium) {
        console.log('   â†’ Channel should be:', params.utm.medium === 'organic' ? 'organic' : params.utm.medium === 'cpc' ? 'paid' : params.utm.medium === 'social' ? 'social' : 'unknown');
      }
    } else {
      console.warn('âš ï¸ No UTM parameters detected. Click a traffic source link to test.');
    }
  })();
  
  sendEvent('pageview');
  (function(){
    let engaged=false;
    const markEngaged=()=>{ if(engaged) return; engaged=true; sendEvent('engaged'); };
    const markBounce =()=>{ if(engaged) return; sendEvent('bounce'); };
    setTimeout(markEngaged, 30_000);
    window.addEventListener('scroll', ()=>{ const s=(window.scrollY+window.innerHeight)/(document.documentElement.scrollHeight||1); if(s>=0.75) markEngaged(); }, { passive:true });
    window.addEventListener('beforeunload', markBounce);
  })();
</script>
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <a href="index.html" class="logo">DMwithAI Store</a>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="products.html">Products</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
    </div>
  </nav>

  <main class="container">
    <section class="hero">
      <h1>Welcome to DMwithAI Demo Store ðŸš€</h1>
      <p class="subtitle">Testing Cohort Retention & Audience Segmentation</p>
      <p>This is a demo site to test the DMwithAI analytics modules. Navigate through different pages and interact with elements to generate tracking events.</p>
    </section>

    <section class="features">
      <h2>What You Can Test</h2>
      <div class="feature-grid">
        <div class="feature-card">
          <h3>ðŸ“Š Cohort Retention</h3>
          <p>Track user retention over time by signup date, channel, and campaign.</p>
          <ul>
            <li>Signup detection from first session</li>
            <li>Retention at Day 1, 7, 14, 30</li>
            <li>Channel-based cohorts</li>
            <li>Campaign-based cohorts</li>
          </ul>
        </div>
        <div class="feature-card">
          <h3>ðŸŽ¯ Audience Segmentation</h3>
          <p>Identify high-performing audience segments by behavior and demographics.</p>
          <ul>
            <li>New vs Returning visitors</li>
            <li>Channel segmentation</li>
            <li>Engagement-based segments</li>
            <li>Conversion rate analysis</li>
          </ul>
        </div>
      </div>
    </section>

    <section class="traffic-sources">
      <h2>Test Different Traffic Sources</h2>
      <p>Click these links to simulate different acquisition channels:</p>
      <div class="traffic-links">
        <button onclick="sendEvent('pageview', {utm: {source: 'google', medium: 'organic', campaign: 'seo'}}); alert('âœ… Organic UTM event sent! Check /debug/last-event endpoint');" class="traffic-link organic" style="border: none; cursor: pointer; width: 100%;">Organic Search (Test)</button>
        <button onclick="sendEvent('pageview', {utm: {source: 'google', medium: 'cpc', campaign: 'summer_sale'}}); alert('âœ… Paid UTM event sent! Check /debug/last-event endpoint');" class="traffic-link paid" style="border: none; cursor: pointer; width: 100%;">Paid Search (Test)</button>
        <button onclick="const utmData = {utm: {source: 'facebook', medium: 'social', campaign: 'brand_awareness'}}; console.log('ðŸ” Sending social UTM:', utmData); sendEvent('pageview', utmData); alert('âœ… Social UTM event sent! Check /debug/last-event endpoint');" class="traffic-link social" style="border: none; cursor: pointer; width: 100%;">Social Media (Test)</button>
        <button onclick="sendEvent('pageview', {}); alert('âœ… Direct traffic event sent!');" class="traffic-link direct" style="border: none; cursor: pointer; width: 100%;">Direct Traffic (Test)</button>
      </div>
      <p style="margin-top: 15px; font-size: 14px; color: #666;">
        <strong>Note:</strong> GitHub Pages strips query parameters via redirects. On a real site, UTM parameters will work normally. 
        The test buttons above send UTM params directly in the event payload for testing purposes. They don't reload the page.
      </p>
      <p style="margin-top: 10px; font-size: 12px; color: #999;">
        After clicking a test button, check: <code>https://dmwithai.selftrainai.com/api/collector/debug/last-event</code>
      </p>
    </section>

    <section class="actions">
      <h2>Quick Actions</h2>
      <div class="action-buttons">
        <a href="products.html" class="btn btn-primary">Browse Products</a>
        <a href="contact.html" class="btn btn-secondary">Contact Us</a>
        <button onclick="sendEvent('conversion', {goal: 'newsletter_signup', value: 0})" class="btn btn-success">Sign Up for Newsletter</button>
      </div>
    </section>

    <section class="info">
      <h2>Tracking Events</h2>
      <p>The following events are automatically tracked:</p>
      <ul>
        <li><strong>pageview</strong> - On every page load</li>
        <li><strong>engaged</strong> - After 30 seconds or 75% scroll</li>
        <li><strong>bounce</strong> - On quick exit without engagement</li>
        <li><strong>conversion</strong> - On button clicks (newsletter, purchase, etc.)</li>
      </ul>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 DMwithAI Demo Store. Built for testing analytics modules.</p>
    </div>
  </footer>
</body>
</html>
