<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DMwithAI Demo Store - Home</title>
  <link rel="stylesheet" href="styles.css">
<!-- Google tag (gtag.js) -->
<script>
  /* === CONFIG (generated) === */
  const COLLECTOR_BASE = "http://localhost:8002";
  const TENANT_ID = "2";
  const SITE_TOKEN = "icE56lQxxTWOwTR8dntpNkj-I-Vrxl0-";

  function sid() {
    // Use localStorage for cross-session persistence (better for returning user detection)
    // Falls back to sessionStorage if localStorage unavailable
    const k = "_our_sid";
    let storage = typeof localStorage !== 'undefined' ? localStorage : sessionStorage;
    let v = storage.getItem(k);
    if (!v) {
      v = Math.random().toString(36).slice(2)+Date.now().toString(36);
      try {
        storage.setItem(k, v);
      } catch(e) {
        // Fallback to sessionStorage if localStorage fails (e.g., private mode)
        if (storage !== sessionStorage) {
          storage = sessionStorage;
          storage.setItem(k, v);
        }
      }
    }
    return v;
  }
  function getParams() {
    const sp = new URLSearchParams(location.search);
    const g = k => sp.get(k) || undefined;
    return { utm: { source:g('utm_source'), medium:g('utm_medium'), campaign:g('utm_campaign'), term:g('utm_term'), content:g('utm_content') },
              clid: { gclid:g('gclid'), fbclid:g('fbclid'), ttclid:g('ttclid') } };
  }
  function sendEvent(type, extra = {}) {
    const payload = { t:type, tenantId:TENANT_ID, siteToken:SITE_TOKEN, url:location.href, ref:document.referrer||null, sid:sid(), ...getParams(), ...extra };
    const body = JSON.stringify(payload);
    if (navigator.sendBeacon) {
      navigator.sendBeacon(`${COLLECTOR_BASE}/collect`, new Blob([body], { type: 'text/plain;charset=UTF-8' }));
      return;
    }
    fetch(`${COLLECTOR_BASE}/collect`, {
      method:'POST',
      headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
      body,
      keepalive:true
    }).catch(()=>{});
  }
  sendEvent('pageview');
  (function(){
    let engaged=false;
    const markEngaged=()=>{ if(engaged) return; engaged=true; sendEvent('engaged'); };
    const markBounce =()=>{ if(engaged) return; sendEvent('bounce'); };
    setTimeout(markEngaged, 30_000);
    window.addEventListener('scroll', ()=>{ const s=(window.scrollY+window.innerHeight)/(document.documentElement.scrollHeight||1); if(s>=0.75) markEngaged(); }, { passive:true });
    window.addEventListener('beforeunload', markBounce);
  })();
  
  /* === CONVERSION TRACKING === */
  // Option A: Manual tracking - websites can call sendEvent('conversion', { goal: 'purchase', value: 99.99 })
  // Option C: Automatic form submission detection
  (function(){
    let conversionTracked = false;
    const trackConversion = (source, metadata = {}) => {
      if (conversionTracked) return; // Only track one conversion per session
      conversionTracked = true;
      sendEvent('conversion', { source: source, ...metadata });
    };
    
    // Make sendEvent available globally for manual tracking (Option A)
    window.sendConversionEvent = (goal, value) => {
      trackConversion('manual', { goal: goal || 'conversion', value: value });
    };
    
    // Option C: Automatic form submission detection
    document.addEventListener('submit', (e) => {
      const form = e.target;
      if (!form || form.tagName !== 'FORM') return;
      
      // Check if form has data attribute to exclude it
      if (form.dataset.trackConversion === 'false') return;
      
      // Extract form metadata
      const formId = form.id || form.name || 'unknown';
      const formAction = form.action || location.href;
      const formMethod = form.method || 'get';
      
      // Check for common conversion form patterns
      const conversionPatterns = [
        /signup|register|subscribe|newsletter/i,
        /contact|inquiry|lead|quote/i,
        /checkout|purchase|order|buy/i,
        /download|demo|trial/i,
        /apply|application/i
      ];
      
      const isConversionForm = 
        form.dataset.trackConversion === 'true' ||
        conversionPatterns.some(pattern => 
          pattern.test(formId) || 
          pattern.test(formAction) || 
          pattern.test(form.className)
        );
      
      if (isConversionForm) {
        // Extract form data for metadata
        const formData = new FormData(form);
        const metadata = {
          goal: form.dataset.conversionGoal || 'form_submission',
          form_id: formId,
          form_action: formAction,
          form_method: formMethod
        };
        
        // Try to extract value if present in form
        const valueField = form.querySelector('[name*="value"], [name*="amount"], [name*="price"]');
        if (valueField && valueField.value) {
          const parsedValue = parseFloat(valueField.value);
          if (!isNaN(parsedValue)) {
            metadata.value = parsedValue;
          }
        }
        
        trackConversion('form_submission', metadata);
      }
    }, true); // Use capture phase to catch all form submissions
  })();
</script>
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <a href="index.html" class="logo">DMwithAI Store</a>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="products.html">Products</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
    </div>
  </nav>

  <main class="container">
    <section class="hero">
      <h1>Welcome to DMwithAI Demo Store ðŸš€</h1>
      <p class="subtitle">Testing Cohort Retention & Audience Segmentation</p>
      <p>This is a demo site to test the DMwithAI analytics modules. Navigate through different pages and interact with elements to generate tracking events.</p>
    </section>

    <section class="features">
      <h2>What You Can Test</h2>
      <div class="feature-grid">
        <div class="feature-card">
          <h3>ðŸ“Š Cohort Retention</h3>
          <p>Track user retention over time by signup date, channel, and campaign.</p>
          <ul>
            <li>Signup detection from first session</li>
            <li>Retention at Day 1, 7, 14, 30</li>
            <li>Channel-based cohorts</li>
            <li>Campaign-based cohorts</li>
          </ul>
        </div>
        <div class="feature-card">
          <h3>ðŸŽ¯ Audience Segmentation</h3>
          <p>Identify high-performing audience segments by behavior and demographics.</p>
          <ul>
            <li>New vs Returning visitors</li>
            <li>Channel segmentation</li>
            <li>Engagement-based segments</li>
            <li>Conversion rate analysis</li>
          </ul>
        </div>
      </div>
    </section>

    <section class="traffic-sources">
      <h2>Test Different Traffic Sources</h2>
      <p>Click these links to simulate different acquisition channels:</p>
      <div class="traffic-links">
        <button onclick="sendEvent('pageview', {utm: {source: 'google', medium: 'organic', campaign: 'seo'}}); alert('âœ… Organic UTM event sent! Check /debug/last-event endpoint');" class="traffic-link organic" style="border: none; cursor: pointer; width: 100%;">Organic Search (Test)</button>
        <button onclick="sendEvent('pageview', {utm: {source: 'google', medium: 'cpc', campaign: 'summer_sale'}}); alert('âœ… Paid UTM event sent! Check /debug/last-event endpoint');" class="traffic-link paid" style="border: none; cursor: pointer; width: 100%;">Paid Search (Test)</button>
        <button onclick="const utmData = {utm: {source: 'facebook', medium: 'social', campaign: 'brand_awareness'}}; console.log('ðŸ” Sending social UTM:', utmData); sendEvent('pageview', utmData); alert('âœ… Social UTM event sent! Check /debug/last-event endpoint');" class="traffic-link social" style="border: none; cursor: pointer; width: 100%;">Social Media (Test)</button>
        <button onclick="sendEvent('pageview', {}); alert('âœ… Direct traffic event sent!');" class="traffic-link direct" style="border: none; cursor: pointer; width: 100%;">Direct Traffic (Test)</button>
      </div>
      <p style="margin-top: 15px; font-size: 14px; color: #666;">
        <strong>Note:</strong> GitHub Pages strips query parameters via redirects. On a real site, UTM parameters will work normally. 
        The test buttons above send UTM params directly in the event payload for testing purposes. They don't reload the page.
      </p>
      <p style="margin-top: 10px; font-size: 12px; color: #999;">
        After clicking a test button, check: <code>https://dmwithai.selftrainai.com/api/collector/debug/last-event</code>
      </p>
    </section>

    <section class="actions">
      <h2>Quick Actions</h2>
      <div class="action-buttons">
        <a href="products.html" class="btn btn-primary">Browse Products</a>
        <a href="contact.html" class="btn btn-secondary">Contact Us</a>
        <button onclick="sendEvent('conversion', {goal: 'newsletter_signup', value: 0})" class="btn btn-success">Sign Up for Newsletter</button>
      </div>
    </section>

    <section class="info">
      <h2>Tracking Events</h2>
      <p>The following events are automatically tracked:</p>
      <ul>
        <li><strong>pageview</strong> - On every page load</li>
        <li><strong>engaged</strong> - After 30 seconds or 75% scroll</li>
        <li><strong>bounce</strong> - On quick exit without engagement</li>
        <li><strong>conversion</strong> - On button clicks (newsletter, purchase, etc.)</li>
      </ul>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 DMwithAI Demo Store. Built for testing analytics modules.</p>
    </div>
  </footer>
</body>
</html>
